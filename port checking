#!/usr/bin/env bash
set -euo pipefail

LOG_FILE="${LOG_FILE:-$HOME/ora_check.log}"
ORATAB="${ORATAB:-/etc/oratab}"
db_name="${PT_dbname:-}"

timestamp() { date '+%a %b %d %T %Y'; }

if [[ -z "$db_name" ]]; then
  echo "$(timestamp) | ERROR | PT_dbname is not set. Export it, e.g. 'export PT_dbname=ORCL'." | tee -a "$LOG_FILE"
  exit 3
fi

# Find PMON for the DB
pmon_id="$(pgrep -f "ora_pmon_${db_name}" || true)"
if [[ -z "$pmon_id" ]]; then
  echo "$(timestamp) | INFO | DATABASE ${db_name} is not running on $(hostname)" | tee -a "$LOG_FILE"
  exit 1
fi

# Derive ORACLE_SID from the PMON command
instance_name="$(ps -o cmd= -p "$pmon_id")"
ORACLE_SID="$(awk -F'_' '{print $3}' <<< "$instance_name")"

# Find ORACLE_HOME from oratab
ORACLE_HOME="$(grep -E "^${db_name}:" "$ORATAB" | awk -F: 'END{print $2}')"
if [[ -z "${ORACLE_HOME}" ]]; then
  echo "$(timestamp) | ERROR | DATABASE ${db_name} not found in ${ORATAB} on $(hostname)" | tee -a "$LOG_FILE"
  exit 2
fi

export ORACLE_SID ORACLE_HOME
PATH="$ORACLE_HOME/bin:$PATH"

# tnsping check (capture output once)
if ! command -v tnsping >/dev/null 2>&1; then
  echo "$(timestamp) | ERROR | tnsping not found in PATH. Expected under ${ORACLE_HOME}/bin." | tee -a "$LOG_FILE"
  exit 4
fi

echo "$(timestamp) | INFO | Running tnsping for ${db_name}..." | tee -a "$LOG_FILE"
tns_out="$(tnsping "$db_name" 2>&1 || true)"
echo "$tns_out" | tee -a "$LOG_FILE"

# If tnsping failed, bail out
if ! echo "$tns_out" | grep -qiE '\bOK\b'; then
  echo "$(timestamp) | ERROR | tnsping failed for ${db_name}" | tee -a "$LOG_FILE"
  exit 5
fi
echo "$(timestamp) | INFO | tnsping succeeded for ${db_name}" | tee -a "$LOG_FILE"

# ---- Port extraction & status ----
port_value="$(echo "$tns_out" | awk -F'PORT *= *' '/PORT *=/{print $2}' | cut -d')' -f1 | head -1)"

if [[ -z "$port_value" ]]; then
  echo "$(timestamp) | ERROR | Could not extract PORT value from tnsping output." | tee -a "$LOG_FILE"
  exit 6
fi

if [[ "$port_value" == "1521" ]]; then
  echo "$(timestamp) | STATUS | FAIL | Port is default (1521)" | tee -a "$LOG_FILE"
  exit 1
else
  echo "$(timestamp) | STATUS | PASS | Port is $port_value (non-default)" | tee -a "$LOG_FILE"
  exit 0
fi
